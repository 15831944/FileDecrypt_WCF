[toc]

![](https://www.youngcoding.top/wp-content/uploads/2017/12/encrypt.jpg)

## 背景
几年前公司花大价钱购买了国产某喻公司开发的InteXX防扩散系统(以下简称XX软件)，主要用来加密电脑上的AutoCAD图纸、PDF文档、图片、SolidWorks三维模型、Inventor三维模型等文件。但后来在推进部署过程中几经波折，而且其每天必须在线授权、最多离线十天的机制也对公司长期在外出差人员造成很大困扰(出差第11天，电脑上所有图纸、PDF、图片打不开了...)，加之上层领导不重视，这套加密系统已名存实亡，这两年公司大部分新装电脑已不要求安装XX软件。但公司内部已有很多电脑安装了xx软件，文件被加密，且加密后的文件只能在也安装了xx软件的电脑上打开，所以也就无法卸载。由于存在大量未装xx软件的电脑，同事间共享图纸资料等变得不可能。虽然有解密服务，但需领导层层审批，好像解密授权数量还有限制，不能人手一个授权。。。本着探索研究的精神，我研究了xx软件的加密行为，并找到了一个巧妙的绕过加密的办法~~ 下面开拔。

## xx软件特点
### 高安全性
网上找了一段介绍，这不是广告~
>xx加密软件采用国际上先进的加密算法，结合目前流行的硬件智能卡技术：将核心算法和密钥存放在用于银行系统的智能卡中，智能卡就象一个黑盒子，您只能执行它的程序，但不能跟踪里面的代码，并且物理上不可复制，确保安全。在安全性方面采用三层加密体系：首先是外部存储层，基于智能卡的密钥存储机制，难以获取；然后是传输层，基于3DES的加密传输机制，难以破解；最后是数据加密层，支持高级加密标准算法AES算法，具有较高的加密强度，使任何暴力攻击措施都是徒劳的。  
>听起来很牛X的样子。我用空白文本文件更改为.pdf后缀让其加密，然后与原文件的副本进行详细对比，也拦截分析了后台进程与服务器的通讯请求，最后得出结论：我还没那个水平去破解~~ 当然，这也因为我水平太菜  

### 加密透明
此XX软件安装后默认在后台运行，有两个服务进程，若用任务管理器强行结束，立刻蓝屏死机。安装该软件后，每天会定时扫描全盘符合加密条件的文件(后缀名识别)并进行加密。安装了XX软件的电脑，打开AutoCAD图纸等加密文件时，仍与未安装前无任何区别，支持直接双击打开，即整个加密、解密过程对用户是透明的。且其只针对符合特定后缀名的文件加密。

## xx软件行为分析

### 试验与分析

>因本人工作中用AutoCAD程序较多，所以下文多以AutoCAD为例进行探究，想来其他软件应该是一通百通的。

本人对加密行业不太了解，只能通过各种试验来验证猜想，然后根据现象做浅陋的分析：
1. xx软件只针对特定后缀名文件进行加密，其他文件不加密，肯定不是全盘加密。
2. xx软件加密、解密行为对用户透明，经过其加密的文件仍然能双击直接调用对应的程序打开。其加密的文件类型涉及AutoDesk公司(AutoCAD, Inventor)、达索公司(SolidWorks)、Adobe(Acrobat)、微软(系统自带看图)这些大公司出品的软件，所以其加、解密过程不可能是在这几大公司出品的软件内部完成的，即这玩意儿是个外挂，要么挂在系统级别监视磁盘文件写入和读取；要么挂在目标软件上，用类似于钩子或注入的技术监视其打开、保存文件的动作。(以我的理解，后一种几乎不可能，因为上述商业公司的软件不公开源码，写钩子难度大；再者，用钩子或者注入技术的话，杀软会报毒吧~~此处应该感谢360)
3. 同样是加密的PDF文件，我用Acrobat可以顺利打开，但用Foxit福昕阅读器就不行。可见，xx软件有个`软件白名单`，在白名单内的软件，读取文件时就在后台给其解密。
4. Acrobat和Foxit分别编辑一个未加密的pdf文件然后保存，Acrobat保存的文件立即就被加密了，而Foxit保存的文件仍保持未加密状态，直到下次全盘扫描才加密。这得出两点结论：a)加密不是实时的，这也可以从外来的未加密文件不会立即被加密来得到确认；b)应该存在一个`监视软件名单`(很可能与上面的`软件白名单`是一个)，在名单内的软件保存文件立即加密。
5. 未加密文件的复制、粘贴不会引起加密。可见，系统级的复制、粘贴程序不在加密监视名单内，更加确认了这个监视名单存在。PS：当然了，如果粘贴会加密，那就会加密一切能被粘贴的文件了~~
6. 从其他未加密电脑拷贝了多个未加密.dwg文件，部分更改后缀名为.txt，经过两天的全盘扫描加密过程，所有.dwg后缀文件被加密，所有改为.txt的文件未被加密。可见，xx软件在全盘扫描时靠后缀名来筛选过滤。

### 结论
由上面的试验结果与分析，我们应该可以得出如下结论：
1. xx软件应该是一个系统级或驱动级的外挂式加密软件；
2. xx软件应该有一个`软件白名单`，软件白名单内的软件读取磁盘文件时，先进行解密(系统级的操作，外部无从感知)；
3. xx软件应该有一个`监视软件名单`，很可能与白名单就是一个，监视名单内的软件写入磁盘文件时，立即加密；
4. xx软件在扫描全盘时有一个后缀名过滤名单，在名单内的文件立即被加密。

## 找小路
### 思路一：偷内存
既然基本确定xx软件是个系统级的加密软件，而且AutoCAD能顺利打开加密图纸并成功解析其中的内容，那说明AutoCAD内存中的数据是正确解密的。(如上分析中的第2点，我想X喻公司还没有牛到能让AutoCAD兼容它的加密算法的地步吧~再者，算法给别人也不安全了是吧~)
**直接想法**:既然内存数据是解密的，那就把内存数据导出来存为dwg图纸！！
但在实施时遇到问题：
1. 如何获取内存数据？我试过用AutoCAD插件获取内存中的图档对象然后保存，结果是保存的图纸是加密格式的。可见xx软件的监视软件名单应该是进程级别的(插件是另开线程执行的)。
2. 内存数据结构与保存到文件中的数据格式多半是不一样的，怎么映射和解析？
3. 好几款软件，每一款都要去研究怎么偷内存？上班狗，耗不起。。
  
此种方案可行性较低，搁置。

### 思路二：传内存
既然你一直监视我保存文件，那我将内存中的解密数据传给他人，让不在监视名单的第三方去保存行了吧！！
也存在如下问题：
1. 进程间通讯(这个倒不是什么大问题);
2. 传过去第三方如何解析，如何保存？

第2点无解。

### 思路三：骗内存
**大胆假设**  
`监视软件名单`是靠什么判断目标软件应该写入时加密、读出时解密的？靠进程名？靠exe文件指纹或签名？我们大胆假设一下是靠进程名也就是exe文件名吧~
**小心求证**  
为了证明xx软件是靠进程名来监视软件行为的，我将一个包含"hello decrypt"的文本文件改名为test.dwg，让系统加密，然后编写了一个C#命令行程序以文本方式读取该文件再打印，最后将该命令行程序改名为acad.exe(同AutoCAD可执行文件名)。运行后，控制台输出了`hello decrypt`，解密了！哈哈，忍不住赞叹一声：果然是靠进程名来甄别的！

## 绕路

### 单机版

接下来就简单了，只需用伪装后acad.exe以二进制方式读取加密文件(读取即解密)，然后将二进制数据传送给第三方保存即可(不在`监视软件名单`，保存不会加密)。但这有个前提：运行伪装程序的电脑必须安装xx软件。

### 服务器版
有的人电脑上未装xx软件，则可以采用虚拟机安装xx软件的方式。当时正好在学习C#的WCF通讯，就顺手做了个服务器版，具体见[Github](https://github.com/YoungCoding/FileDecrypt_WCF)。

简单来说，就是在服务器端运行一个传输服务，和解密服务(即之前提到的伪装程序)，客户端将加密文件上传到传输服务(WCF通讯)，服务端传输服务将文件保存到本地(加密的)，然后通知解密服务读取该文件(内存中为解密后的字节流)，再通过WCF将字节流传给传输服务，由传输服务返回到客户端。整个过程中，通过伪装程序读取加密文件，传给第三方(传输服务和客户端)进行保存，这样我们就得到了一个解密后的文件了。

---

免责声明：本文仅为作者个人学习研究用，严禁用于商业用途或其他不正当用途，若违反而造成的一切后果与本人无关。
